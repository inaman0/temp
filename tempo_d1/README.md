# Keycloak Authentication with Spring Security

This project integrates **Keycloak** with **Spring Security** to provide authentication and authorization for a Spring Boot application. The authentication flow supports **access tokens**, **refresh tokens**, and **secure session management**.

## Features
- Keycloak integration for authentication
- Stateless session management with JWT tokens
- Custom security filter for token validation and automatic refresh
- CORS configuration for frontend integration
- REST APIs for authentication and user management

## Technologies Used
- **Spring Boot**
- **Spring Security**
- **Keycloak** (OIDC Provider)
- **JWT (JSON Web Tokens)**
- **RestTemplate** (for token introspection and refresh)
- **Jakarta Servlet API** (for request handling)

## Project Structure
```
/src/main/java/com/example/demo
|-- config
|   |-- SecurityConfig.java
|   |-- KeycloakTokenFilter.java
|
|-- controller
|   |-- AuthController.java
|
|-- application.properties
```

## Configuration
### 1. Keycloak Setup
1. Start Keycloak and create a realm (`demo-realm`).
2. Add a new **client** (`spring-backend`) with:
   - **Client ID:** `spring-backend`
   - **Client Secret:** *(generated by Keycloak)*
   - **Access Type:** `confidential`
   - **Redirect URI:** `http://localhost:8080/login/oauth2/code/keycloak`
3. Create a test user and assign roles.
4. Configure the **client authentication** to allow token introspection.

### 2. Spring Boot Configuration
#### `application.properties`
```properties
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8080/realms/demo-realm
spring.security.oauth2.client.registration.keycloak.client-id=spring-backend
spring.security.oauth2.client.registration.keycloak.client-secret=your-client-secret
spring.security.oauth2.client.provider.keycloak.token-uri=http://localhost:8080/realms/demo-realm/protocol/openid-connect/token
```

## Key Components
### 1. `SecurityConfig.java`
- Configures **CORS**, **CSRF**, and **session management**.
- Sets up **OAuth2 resource server** with JWT decoding.
- Registers `KeycloakTokenFilter` before the `BearerTokenAuthenticationFilter`.

### 2. `KeycloakTokenFilter.java`
- Extracts and validates **access tokens**.
- If the access token is expired, it **refreshes** using the refresh token.
- Updates the request headers with the new token for seamless authentication.

### 3. `AuthController.java`
- Exposes APIs for:
  - **Login** (`/api/auth/login`)
  - **Logout** (`/api/auth/logout`)
  - **User registration** (`/api/auth/register`)
  - **Callback handling** (`/api/auth/callback`)

## Running the Application
### 1. Start Keycloak
```sh
docker run -p 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak start-dev
```

### 2. Start Spring Boot Application
```sh
./mvnw spring-boot:run
```

### 3. Test API Endpoints
#### Login:
```sh
POST http://localhost:8082/api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password"
}
```
#### Protected Resource:
```sh
GET http://localhost:8082/api/protected
Authorization: Bearer <ACCESS_TOKEN>
```

## Frontend Integration
- Ensure frontend requests send the **Authorization** header.
- Store and manage access/refresh tokens in **cookies or local storage**.

## Notes
- Adjust `CLIENT_ID`, `CLIENT_SECRET`, and `REALM_NAME` in `SecurityConfig.java` and `KeycloakTokenFilter.java`.
- CORS allows requests from `http://localhost:5173` (adjust as needed).

## TODO
- Implement role-based authorization.

---
This README provides an overview of the authentication setup using Keycloak and Spring Security. For any issues, check the Keycloak logs and API responses!

